
@{
    Layout = null;
}
<html>
<head>
    <title>Дневник погоды</title>

    <script src="~/Scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
    <script src="~/Scripts/chosen.jquery.js" type="text/javascript"></script>
    <!--<link rel="stylesheet" href="~/Content/docsupport/style.css">-->
    <link rel="stylesheet" href="~/Content/docsupport/prism.css">
    <link rel="stylesheet" href="~/Content/chosen.css">
    <link href="~/Content/bootstrap-theme.css" rel="stylesheet" />
    <link href="~/Content/bootstrap.css"  rel="stylesheet" type="text/css" />
    <link href="~/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/jquery.jqGrid/ui.jqgrid.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/jquery-ui-1.8.24.min.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="~/Scripts/i18n/grid.locale-ru.js" type="text/javascript"></script>
    <link href="~/Content/themes/base/jquery.ui.core.css" rel="stylesheet" type="text/css" />

    @*<meta charset="utf-8">   
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="/resources/demos/style.css">*@


    @*<link href="~/Content/themes/base/jquery.ui.datepicker.css")" rel="stylesheet" type="text/css" />*@
   
     @*<link href="~/Content/bootstrap.css")" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap-responsive.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap-responsive.min.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/datepicker3.css")" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap.min.css" )" rel="stylesheet" type="text/css" />



    <link href="~/Content/themes/base/jquery.ui.theme.css")" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/bootstrap.js")" type="text/javascript"></script>*@
    <script src="~/Scripts/locales/bootstrap-datepicker.ru.js"  type="text/javascript"></script>
    @*<script src="~/Scripts/bootstrap.min.js" )" type="text/javascript"></script>
    <script src="~/Scripts/bootstrap-datepicker.js")" type="text/javascript"></script>*@
    <style>
        .ui-jqgrid .ui-pg-input {
             height: 20px;
        }
     
    </style>
   
    
    <style type="text/css" media="all" > 
        .ui-jqgrid .ui-pg-input {
            height: 20px;
        }
        .chosen-rtl .chosen-drop {
            left: -9000px;
        }

        #Button1 {
            width: 109px;
        }
     
        #date1 {
            width: 236px;
        }
        #date2 {
            width: 305px;
            margin-left: 122px;
        }
     
    </style>

</head>
<body>
    <div class="alert alert-success" align="center">    <h2>Дневник погоды</h2> </div>
     @*@using (Html.BeginForm())*@
        
            @*@Html.TextBox("date1") <!-- Дата с -->
            @Html.TextBox("date2") <!-- Дата по -->*@


            @*<p>
                Введите первую дату: @Html.TextBox("exampleDateTime2", null, new { @class = "datePicker" })
                Введите вторую дату: @Html.TextBox("exampleDateTime3", null, new { @class = "datePicker2" })
            </p>

            <p>
                Выберите дату: <input type="date" name="calendar">    
            </p>*@
    <div class="container border-container">
        <div class="row">
            <div class="col-md-4 col-sm-6" align="right">
                <label for="Regions">Регион</label>
                <select id="Regions" name="Regions"></select>
            </div>
            <div class="col-md-3 col-sm-6" align="right">
                <label for=" from">
                    Период с
                </label>
                <input type="text" id="from" name="from">
            </div>
        </div>
        <br />
        <br />
        <div class="row">
            <div class="col-md-4 col-sm-6 " align="right">
                <label id="cit" for="Cities">Город</label>
                <select id="Cities" name="Cities"></select>
            </div>
            <div class="col-md-3 col-sm-6" align="right">
                <label for="to">по</label>
                <input type="text" id="to" name="to">
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-4 col-sm-6 " align="right">
                </div>
            <div class="col-md-3 col-sm-6" align="right">
                <button type="button" class="btn btn-primary" onclick="Sub()"> Показать</button>
                </div>
            </div>
        </div>
    <div class="container">
        <div class="alert alert-danger" id="city_error">
            <strong>Ошибка!</strong> Укажите город! .
        </div>
        </div>
    <script>
        $('#city_error').hide();
    </script>
    <br />
    <br />

            <!---->
    <p align="center" style="margin:0px;"">
        <table id="jqg"></table>

    </p>

  <div id="pager_content" class="ui-jqgrid ui-widget ui-widget-content ui-corner-all" style="margin: 0 auto; display:none;" dir="ltr">
	<div id="" class="ui-jqgrid-resize-mark"> </div>
		<div id="p-c" class="ui-state-default ui-jqgrid-pager ui-corner-bottom" dir="ltr">
			<div display:inline;" id="pager" >
				<span class="ui-icon ui-icon-seek-prev" id="prev" onclick="prev()"></span>
				<span class="ui-separator"></span>

				<span id="cur">1</span>  из <span id="total">1</span>
				<span class="ui-separator"></span>
				<span class="ui-icon ui-icon-seek-next" id="next" onclick="next()"></span>

				<select role="listbox" class="ui-pg-selbox" id="rowCount" style="display: inline;">
					<option value="10" role="option">10</option>
					<option value="20" role="option">20</option>
					<option value="30" role="option">30</option>
				</select>
			</div>
		</div>
	</div>
</div>

            <style>
                .ui-icon-seek-prev {
                    height: 16px !important;
                    width: 16px !important;
                    display: inline-block !important;
                    overflow: hidden !important;
                }

                .ui-icon-seek-next {
                    height: 16px !important;
                    width: 16px !important;
                    display: inline-block !important;
                    overflow: hidden !important;
                }
            </style>
  <!--  <p align="center">
        <div style="display:none" id="pager" align="center">
            <span class="ui-icon ui-icon-seek-prev" id="prev" onclick="prev()"></span>
            <span class="ui-separator"></span>

            <span id="cur">1</span>  из <span id="total">1</span>
            <span class="ui-separator"></span>
            <span class="ui-icon ui-icon-seek-next" id="next" onclick="next()"></span>

            <select role="listbox" class="ui-pg-selbox" id="rowCount">
                <option value="10" role="option">10</option>
                <option value="20" role="option">20</option>
                <option value="30" role="option">30</option>
            </select>
        </div>
    </p>    -->
            <span id="sort_click" style="display:none;">0</span>
            
</body>

</html>


<script>

    $(function () {
        $.getJSON("/Home/Regions/List", function (data) {
            var items = "<option></option>";
            $.each(data, function (i, reg) {
                items += "<option value='" + reg.Value + "'>" + reg.Text + "</option>";
            });
            $("#Regions").html(items);

            $("#Regions").val($("#Regions option:contains('Ульяновская область')").val());
            $("#Regions").change();

            $("#Regions").chosen();

        });

        $("#Regions").change(function () {
            $.getJSON("/Home/Cities/List/" + $("#Regions > option:selected").attr("value"), function (data) {
                var items = "<option></option>";
                $.each(data, function (i, sta) {
                    items += "<option value='" + sta.Text + "'>" + sta.Text + "</option>";
                });
                $("#Cities").html(items);

                $("#Cities").val($("#Cities option:contains('Ульяновск')").val());

                $("#Cities").chosen({ width: '276px' });
                $("#Cities").trigger("chosen:updated");
            });
        });
    });

    function prev() {
        cur = $("#cur").html() - 0 - 1;
        if (cur > 0) {
            ShowTablePage(cur, "DESC");
            getTotalCNT()
        }
    }

    function next() {
        cur = $("#cur").html() - 0 + 1;
        max = $("#total").html() - 0;
        if (cur <= max) {
            ShowTablePage(cur, "DESC");
            getTotalCNT()
        }
    }

    function getTotalCNT() {
        var stringArray = new Array();
        stringArray[0] = $("#from").val();
        stringArray[1] = $("#to").val();
        stringArray[2] = $("#Regions").val();
        stringArray[3] = $("#Cities").val();
        stringArray[4] = 1;
        stringArray[5] = $("#rowCount").val();
        var postData = { values: stringArray };
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetTotalCNT")',
            data: postData,
            success: function (data) {
                $("#total").html(data);
            },
            dataType: "text",
            traditional: true
        });
    }


    $(function () {
        $("#from").datepicker({
            defaultDate: "+1w",

            dateFormat: "dd-mm-yy",

            changeMonth: true,
            numberOfMonths: 3,
            onClose: function (selectedDate) {
                $("#to").datepicker("option", "minDate", selectedDate);
            }
        });
        $("#to").datepicker({
            defaultDate: "+1w",

            dateFormat: "dd-mm-yy",

            changeMonth: true,
            numberOfMonths: 3,
            onClose: function (selectedDate) {
                $("#from").datepicker("option", "maxDate", selectedDate);
            }
        });
    });

    $(document).ready(function () {
        $('.datePicker').datepicker({ firstDay: 1, dateFormat: 'dd.mm.yy' });
        $('.datePicker2').datepicker({ firstDay: 1, dateFormat: 'dd/mm/yy' });
    });

    function Sub() {
        /*if (($("#from").val() == "") || ($("#to").val() == "")) {
            alert("Не указана дата");
            return;
        }*/
        if (($("#Cities").val() == "") || ($("#Cities").val() == null) || ($("#Cities").val() == "----------------------")) {
            $("#cit").css("color", "red");
            $("#city_error").show();
            $("#pager_content").css("display", "none");
            $("#gbox_jqg").css("display", "none");
            return;
        }
        else {
            $("#cit").css("color", "black");
            $("#city_error").hide();
            }
            ShowTablePage(1, "desc");
    }

    function ShowTablePage(page, sort) {
        var stringArray = new Array();
        stringArray[0] = $("#from").val();
        stringArray[1] = $("#to").val();
        stringArray[2] = $("#Regions").val();
        stringArray[3] = $("#Cities").val();       
        stringArray[4] = page;
        stringArray[5] = $("#rowCount").val();
        stringArray[6] = sort;
        var postData = { values: stringArray };

        var result;

        $.ajax({
            type: "POST",
            url: '@Url.Action("GetData")',
            data: postData,
            success: function (data) {
                result = data;
                UpdateTable(result);
                $('#cur').html(page);
                getTotalCNT();
            },
            dataType: "json",
            traditional: true
        });

        $("#pager").css("display", 'block');


       
    }


    function UpdateTable(result) {
        $("#jqg").jqGrid('GridUnload');
        $("#jqg").jqGrid({
            datatype: "jsonstring",
            datastr: result,
            url: '@Url.Action("GetData")',
            jsonReader: { repeatitems: false },
            colNames: ['Дата', 'ЯндексДень', 'OWMДень', 'ЯндексНочь', 'OWMНочь', 'Cк/Ветра Ya', 'Ск/Ветра OWM', 'Давление Ya', 'Давление OWM','Влажность Ya','Влажность OWM', 'Yandex', 'OWM'],
            colModel: [
                        { name: 'date', index: 'date', width: 110, sortable: false },
                        { name: 'yaTempDay', index: 'yaTempDay', width: 90, align: "center", sortable: false },
                        { name: 'owmTempDay', index: 'owmTempDay', width: 80, align: "center", sortable: false },
                        { name: 'yaTempNight', index: 'yaTempNight', width: 90, align: "center", sortable: false },
                        { name: 'owmTempNight', index: 'owmTempNight', width: 80, align: "center", sortable: false },
                        { name: 'yaWindSpeedDay', index: 'yaWindSpeedDay', width: 100, align: "center", sortable: false },
                        { name: 'owmWindSpeedDay', index: 'owmWindSpeedDay', width: 100, align: "center", sortable: false },
                        { name: 'yaPressureDay', index: 'yaPressureDay', width: 100, align: "center", sortable: false },
                        { name: 'owmPressureDay', index: 'owmPressureDay', width: 100, align: "center", sortable: false },
                        { name: 'yaHummidityDay', index: 'yaHummidityDay', width: 100, align: "center", sortable: false },
                        { name: 'owmHummidityDay', index: 'owmHummidityDay', width: 110, align: "center", sortable: false },
                        { name: 'yaSymbolDay', index: 'yaSymbolDay', width: 70, align: "center", sortable: false },
                        { name: 'owmSymbolDay', index: 'owmSymbolDay', width: 70, align: "center", sortable: false },
                      ],

            // Обработка после добавления данных в строку
            afterInsertRow: function (row_id, row_data) {
                $('#jqg').jqGrid('setCell', row_id, 11, "<img src='Images/" + row_data.yaSymbolDay + ".png' width='40' height='40'/>", {});
                $('#jqg').jqGrid('setCell', row_id, 12, "<img src='Images/" + row_data.owmSymbolDay + ".png' width='40' height='40'/>", {});
                //row_data.yaSymbolDay = "<img src='Images/" + row_data.yaSymbolDay + ".png' width='50' height='50'/>";
                if (Math.abs((row_data.yaTempDay) - parseInt(row_data.owmTempDay)) > 2) {
                    var icl;
                    for (icl = 0; icl < 11; icl++) {
                        $('#jqg').jqGrid('setCell', row_id, icl, '', { 'color': 'red' });
                    }
                }
            },
            height: 410,
            rowNum: 100, // число отображаемых строк
            rowList: [10, 20, 30],
            //pager: '#jpager',
            loadonce: true, // загрузка только один раз
            sortable: false,
            caption: "Статистика"
        });

        $("#gbox_jqg").css("display", "");
        $("#pager_content").css("display", "");

        $("#pager_content").css("display", "");
        $("#pager_content").css("width", $("#gview_jqg").width());
        $("#p-c").css("width", $("#gview_jqg").width());
        m_val = ($("#gview_jqg").width()-0 - 150)/2;
        $("#pager").css("margin", "0 "+m_val+"px");

        c = $("#sort_click").html() - 0;
        if (c > 0) {
            $("#jqgh_jqg_date .s-ico").css("display", "");
            if (c % 2 == 0) {
                $("#jqgh_jqg_date .s-ico .ui-icon-asc").toggleClass("ui-state-enabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-asc").toggleClass("ui-state-disabled");
            }
            else {
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-enabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-disabled");
            }
        }

        $("#jqgh_jqg_date").click(function () {
            $("#jqgh_jqg_date .s-ico").css("display", "");
            cnt = $("#sort_click").html() - 0;
            if (cnt > 0) {
                cnt2 = cnt + 1;
                $("#sort_click").html(cnt2);

                if (cnt2 % 2 == 0) {
                    // четное = asc
                    ShowTablePage(1, "asc");
                    getTotalCNT();
                }
                else {
                    // desc
                    ShowTablePage(1, "DESC");
                    getTotalCNT();
                }

            }
            else {
                // делаем видимой сортировку
                $("#jqgh_jqg_date .s-ico").css("display", "");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-disabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-enabled");

                $("#sort_click").html(1);
            }
        });


    }

    $("#rowCount").change(function(){
        // получаем нужное количество данных и обновляем
        ShowTablePage(1, "DESC");
        getTotalCNT();
        $("#sort_click").html(0);
    });

    //$("#my_select [value='2']").attr("selected", "selected");


</script>
