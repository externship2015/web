
@using MvcApplication1.Helpers

@{
    Layout = null;
}
<html>
<head>
    <title>jqGrid</title>
    <script src="~/Scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
    <link href="~/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/jquery.jqGrid/ui.jqgrid.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/jquery-ui-1.8.24.min.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="~/Scripts/i18n/grid.locale-ru.js" type="text/javascript"></script>
    <style>
        .ui-jqgrid .ui-pg-input {
             height: 20px;
        }
     
        #Button1 {
            width: 109px;
        }
     
        #date1 {
            width: 236px;
        }
        #date2 {
            width: 305px;
            margin-left: 122px;
        }
     
    </style>
</head>
<body>



    @using (Html.BeginForm())
    {
        @Html.TextBox("date1") <!-- Дата с -->
        @Html.TextBox("date2") <!-- Дата по -->
        <label for="Regions">Regions</label>
        <select id="Regions" name="Regions"></select>
    
        <label for="Cities">Cities</label>
        <select id="Cities" name="Cities"></select>
             
        <a onclick ="Sub()">Отправить</a> 
    }
    
  
    <script type="text/javascript">
        
        $(document).ready(function () {
            getPager();

            $(".btn.btn-default").click(function () {
                ShowTablePage($(this).html()); // передаем, какую страницу надо загрузить                
            })
        });

        $(function (){
            $.getJSON("/Home/Regions/List", function (data) {
                var items = "<option>----------------------</option>";
                $.each(data, function (i, reg) {
                    items+="<option value='"+reg.Value +"'>"+reg.Text + "</option>";
                });
                $("#Regions").html(items);
            });

             $("#Regions").change(function () {
                $.getJSON("/Home/Cities/List/" + $("#Regions > option:selected").attr("value"), function (data) {
                    var items = "<option>----------------------</option>";
                    $.each(data, function (i, sta) {
                        items += "<option value='" + sta.Text + "'>" + sta.Text + "</option>";
                    });
                    $("#Cities").html(items);
                });
            });
        });
    </script>

   
    <table id="jqg"></table>
    <div id="jpager"></div>
    <div id ="pager"></div>

   <!-- <div id ="pager">
        <a id ="first" onClick ="pageTable('first')">&laquo;</a>
        <a id ="prev" onClick ="pageTable('prev')">&larr;</a>
        <a id ="cur" >1</a>
        <s id ="next" onClick ="pageTable('next')">&rarr;</s>
        <a id ="last" onClick ="pageTable('last')">&raquo;</a>
    </div>
       -->
   
     <script type="text/javascript">

         /*function pageTable(dir)
         {
             
             var cur = $("#cur").html();
             dist = cur-0;
             if (dir = "prev")
                 dist = cur - 1;
             if (dir = "first")
                 dist = 1;
             if (dir = "next")
                 dist = cur + 1;
             if (dir = "last")

         }
         */

         function Sub()
         {
             ShowTablePage(1);
         }

         // в него отдавать номер страницы
         function getPager()
         {
             $.ajax({
                 type: "POST",
                 url: '@Url.Action("getPageData")',                 
                 success: function (data) { 
                     $("#pager").html(data);
                 },
                 dataType: "html",
                 traditional: true
             });
         }

         function ShowTablePage(page)
         {
             var stringArray = new Array();
             stringArray[0] = $("#date1").val();
             stringArray[1] = $("#date2").val();
             stringArray[2] = $("#Regions").val();
             stringArray[3] = $("#Cities").val();
             stringArray[4] = page;
             var postData = { values: stringArray };

             var result;

             $.ajax({
                 type: "POST",
                 url: '@Url.Action("GetData")',
                 data: postData,
                 success: function (data) {
                     result = data;
                     UpdateTable(result);
                 },
                 dataType: "json",
                 traditional: true
             });
         }


         function UpdateTable(result)
         {
             $("#jqg").jqGrid('GridUnload');
             $("#jqg").jqGrid({
                 datatype: "jsonstring",
                 datastr: result,
                 jsonReader: { repeatitems: false },
                 colNames: ['Дата', 'ЯндексНочь', 'ЯндексДень', 'OWMДень', 'OWMНочь', 'Image'],
                 colModel: [
                 { name: 'date', index: 'date', width: 30 },
                 { name: 'yaTempNight', index: 'yaTempNight', width: 150, sortable: true },
                 { name: 'yaTempDay', index: 'yaTempDay', width: 150, sortable: true },
                 { name: 'owmTempDay', index: 'owmTempDay', width: 100, sortable: false },
                 { name: 'owmTempNight', index: 'owmTempNight', width: 80, align: "right", sortable: true },
                 {
                     name: 'Picture', width: 50, fixed: true, formatter: function () {
                         return "<img src='Images/sun.jpg' width='50' height='50'/>";
                     }
                 }
                 ],
                 // Обработка после добавления данных в строку
                 afterInsertRow: function (row_id, row_data) {
                     if (Math.abs((row_data.yaTempNight) - parseInt(row_data.owmTempNight)) > 2) {
                         var icl;
                         for (icl = 0; icl < 5; icl++) {
                             $('#jqg').jqGrid('setCell', row_id, icl, '', { 'color': 'red' });
                         }
                     }
                 },
                 height: 200,
                 rowNum: 10, // число отображаемых строк
                 rowList: [10, 20, 30],
                 pager: '#jpager',
                 loadonce: false, // загрузка только один раз
                 sortname: 'date', // сортировка по умолчанию по столбцу Id
                 sortorder: "desc", // порядок сортировки
                 caption: "Статистика"
             });
         }

    </script>
    <br />
  
       
</body>
</html>