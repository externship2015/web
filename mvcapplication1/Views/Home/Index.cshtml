
@{
    Layout = null;
}
<html>
<head>
    <title>jqGrid</title>

    <script src="~/Scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
    <link href="~/Content/Combobox.css" rel="stylesheet" />
    <script src="~/Scripts/chosen.jquery.js" type="text/javascript"></script>
    <link rel="stylesheet" href="~/Content/docsupport/style.css">
    <link rel="stylesheet" href="~/Content/docsupport/prism.css">
    <link rel="stylesheet" href="~/Content/chosen.css">
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <link href="~/Content/bootstrap-theme.css" rel="stylesheet" />
    <link href="~/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/jquery.jqGrid/ui.jqgrid.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/jquery-ui-1.8.24.min.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="~/Scripts/i18n/grid.locale-ru.js" type="text/javascript"></script>
    <link href="~/Content/themes/base/jquery.ui.core.css")" rel="stylesheet" type="text/css" />

    @*<meta charset="utf-8">   
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="/resources/demos/style.css">*@


    @*<link href="~/Content/themes/base/jquery.ui.datepicker.css")" rel="stylesheet" type="text/css" />*@
   
     @*<link href="~/Content/bootstrap.css")" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap-responsive.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap-responsive.min.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/datepicker3.css")" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap.css" )" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap.min.css" )" rel="stylesheet" type="text/css" />



    <link href="~/Content/themes/base/jquery.ui.theme.css")" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/bootstrap.js")" type="text/javascript"></script>*@
    <script src="~/Scripts/locales/bootstrap-datepicker.ru.js" )" type="text/javascript"></script>
    @*<script src="~/Scripts/bootstrap.min.js" )" type="text/javascript"></script>
    <script src="~/Scripts/bootstrap-datepicker.js")" type="text/javascript"></script>*@
    <style>
        .ui-jqgrid .ui-pg-input {
             height: 20px;
        }
     
    </style>
    <script src="~/Scripts/ComboBox.js"></script>
    
    <style type="text/css" media="all" > 
        .ui-jqgrid .ui-pg-input {
            height: 20px;
        }
        .chosen-rtl .chosen-drop {
            left: -9000px;
        }

        #Button1 {
            width: 109px;
        }
     
        #date1 {
            width: 236px;
        }
        #date2 {
            width: 305px;
            margin-left: 122px;
        }
     
    </style>
</head>
<body>

     @using (Html.BeginForm())
        {
            @*@Html.TextBox("date1") <!-- Дата с -->
            @Html.TextBox("date2") <!-- Дата по -->*@


            @*<p>
                Введите первую дату: @Html.TextBox("exampleDateTime2", null, new { @class = "datePicker" })
                Введите вторую дату: @Html.TextBox("exampleDateTime3", null, new { @class = "datePicker2" })
            </p>

            <p>
                Выберите дату: <input type="date" name="calendar">    
            </p>*@

            <label for="from">From</label>
            <input type="text" id="from" name="from">
            <label for="to">to</label>
            <input type="text" id="to" name="to">


           <label for="Regions">Regions</label>
            <select id="Regions" name="Regions"></select>

            <label for="Cities">Cities</label>
            <select id="Cities" name="Cities"></select>
             
            <a onclick ="Sub()">Отправить</a> 
        }

    <table id="jqg"></table>
    <div id="jpager"></div>
   

    <style>      
        .ui-icon-seek-prev {           
            height:16px !important;
            width:16px !important;
            display: inline-block !important;
            overflow: hidden !important; 
        }

        .ui-icon-seek-next {
            height:16px !important;
            width:16px !important;
            display: inline-block !important;
            overflow: hidden !important;
        }
    </style>

<div style ="display:none" id ="pager" align:center>    
    <span class="ui-icon ui-icon-seek-prev" id ="prev" onclick ="prev()"></span>
    <span class="ui-separator"></span>
     
    <span id ="cur">1</span>  из <span id ="total">1</span>
    <span class="ui-separator"></span>
    <span class="ui-icon ui-icon-seek-next" id ="next" onclick ="next()"></span>
    
    <select role="listbox" class="ui-pg-selbox" id ="rowCount">
	    <option value="10" role="option">10</option>
	    <option value="20" role="option">20</option>
	    <option value="30" role="option">30</option>
    </select>
</div>
    
    <span id ="sort_click" style ="display:none;">0</span>

</body>

</html>


<script>

    $(function () {
        $.getJSON("/Home/Regions/List", function (data) {
            var items = "<option></option>";
            $.each(data, function (i, reg) {
                items += "<option value='" + reg.Value + "'>" + reg.Text + "</option>";
            });
            $("#Regions").html(items);
            $("#Regions").chosen();

        });

        $("#Regions").change(function () {
            $.getJSON("/Home/Cities/List/" + $("#Regions > option:selected").attr("value"), function (data) {
                var items = "<option></option>";
                $.each(data, function (i, sta) {
                    items += "<option value='" + sta.Text + "'>" + sta.Text + "</option>";
                });
                $("#Cities").html(items);
                $("#Cities").chosen({ width: '20%' });
            });
        });
    });

    function prev() {
        cur = $("#cur").html() - 0 - 1;
        if (cur > 0) {
            ShowTablePage(cur, "DESC");
            getTotalCNT()
        }
    }

    function next() {
        cur = $("#cur").html() - 0 + 1;
        max = $("#total").html() - 0;
        if (cur <= max) {
            ShowTablePage(cur, "DESC");
            getTotalCNT()
        }
    }

    function getTotalCNT() {
        var stringArray = new Array();
        stringArray[0] = $("#from").val();
        stringArray[1] = $("#to").val();
        stringArray[2] = $("#Regions").val();
        stringArray[3] = $("#Cities").val();
        stringArray[4] = 1;
        stringArray[5] = $("#rowCount").val();
        var postData = { values: stringArray };
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetTotalCNT")',
            data: postData,
            success: function (data) {
                $("#total").html(data);
            },
            dataType: "text",
            traditional: true
        });
    }


    $(function () {
        $("#from").datepicker({
            defaultDate: "+1w",
            changeMonth: true,
            numberOfMonths: 3,
            onClose: function (selectedDate) {
                $("#to").datepicker("option", "minDate", selectedDate);
            }
        });
        $("#to").datepicker({
            defaultDate: "+1w",
            changeMonth: true,
            numberOfMonths: 3,
            onClose: function (selectedDate) {
                $("#from").datepicker("option", "maxDate", selectedDate);
            }
        });
    });

    $(document).ready(function () {
        $('.datePicker').datepicker({ firstDay: 1, dateFormat: 'dd.mm.yy' });
        $('.datePicker2').datepicker({ firstDay: 1, dateFormat: 'dd/mm/yy' });
    });

    function Sub() {
        if (($("#from").val() == "") || ($("#to").val() == "")) {
            alert("Не указана дата");
            return;
        }
        if (($("#Cities").val() == "") || ($("#Cities").val() == null) || ($("#Cities").val() == "----------------------")) {
            alert("Не выбран город");
            return;
        }
        ShowTablePage(1, "desc");
    }

    function ShowTablePage(page, sort) {
        var stringArray = new Array();
        stringArray[0] = $("#from").val();
        stringArray[1] = $("#to").val();
        stringArray[2] = $("#Regions").val();
        stringArray[3] = $("#Cities").val();       
        stringArray[4] = page;
        stringArray[5] = $("#rowCount").val();
        stringArray[6] = sort;
        var postData = { values: stringArray };

        var result;

        $.ajax({
            type: "POST",
            url: '@Url.Action("GetData")',
            data: postData,
            success: function (data) {
                result = data;
                UpdateTable(result);
                $('#cur').html(page);
                getTotalCNT();
            },
            dataType: "json",
            traditional: true
        });

        $("#pager").css("display", 'block');


       
    }


    function UpdateTable(result) {
        $("#jqg").jqGrid('GridUnload');
        $("#jqg").jqGrid({
            datatype: "jsonstring",
            datastr: result,
            url: '@Url.Action("GetData")',
            jsonReader: { repeatitems: false },
            colNames: ['Дата', 'ЯндексНочь', 'ЯндексДень', 'OWMДень', 'OWMНочь', 'Image', 'Picture'],
            colModel: [
                        { name: 'date', index: 'date', width: 200, sortable: false },
                        { name: 'yaTempNight', index: 'yaTempNight', width: 200, sortable: false },
                        { name: 'yaTempDay', index: 'yaTempDay', width: 200, sortable: false },
                        { name: 'owmTempDay', index: 'owmTempDay', width: 200, sortable: false },
                        { name: 'owmTempNight', index: 'owmTempNight', width: 80, align: "right", sortable: false },
                        { name: 'yaSymbolDay', index: 'yaSymbolDay', width: 80, align: "right", sortable: false },
                        {
                            name: 'Picture', width: 50, fixed: true, formatter: function () {
                                return "<img src='Images/skc_d.jpg' width='50' height='50'/>";
                            }, sortable: false
                        }
            ],

            // Обработка после добавления данных в строку
            afterInsertRow: function (row_id, row_data) {
                row_data.yaSymbolDay = "<img src='Images/" + row_data.yaSymbolDay + ".png' width='50' height='50'/>";
                if (Math.abs((row_data.yaTempNight) - parseInt(row_data.owmTempNight)) > 2) {
                    var icl;
                    for (icl = 0; icl < 5; icl++) {
                        $('#jqg').jqGrid('setCell', row_id, icl, '', { 'color': 'red' });
                    }
                }
            },
            height: 200,
            rowNum: 100, // число отображаемых строк
            rowList: [10, 20, 30],
            //pager: '#jpager',
            loadonce: true, // загрузка только один раз
            sortable: false,
            caption: "Статистика"
        });

        $("#pager").css("display", "inline");

        c = $("#sort_click").html() - 0;
        if (c > 0) {
            $("#jqgh_jqg_date .s-ico").css("display", "");
            if (c % 2 == 0) {
                $("#jqgh_jqg_date .s-ico .ui-icon-asc").toggleClass("ui-state-enabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-asc").toggleClass("ui-state-disabled");
            }
            else {
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-enabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-disabled");
            }
        }

        $("#jqgh_jqg_date").click(function () {
            $("#jqgh_jqg_date .s-ico").css("display", "");
            cnt = $("#sort_click").html() - 0;
            if (cnt > 0) {
                cnt2 = cnt + 1;
                $("#sort_click").html(cnt2);

                if (cnt2 % 2 == 0) {
                    // четное = asc
                    ShowTablePage(1, "asc");
                    getTotalCNT();
                }
                else {
                    // desc
                    ShowTablePage(1, "DESC");
                    getTotalCNT();
                }

            }
            else {
                // делаем видимой сортировку
                $("#jqgh_jqg_date .s-ico").css("display", "");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-disabled");
                $("#jqgh_jqg_date .s-ico .ui-icon-desc").toggleClass("ui-state-enabled");

                $("#sort_click").html(1);
            }
        });


    }

    $("#rowCount").change(function(){
        // получаем нужное количество данных и обновляем
        ShowTablePage(1, "DESC");
        getTotalCNT();
        $("#sort_click").html(0);
    });

    //$("#my_select [value='2']").attr("selected", "selected");


</script>
